<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–õ–æ–±–±–∏ | –ê—É–∫—Ü–∏–æ–Ω –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤</title>
  <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;700&display=swap" rel="stylesheet">
  <style>
    /* –°—Ç–∏–ª–∏ –æ—Å—Ç–∞—é—Ç—Å—è —Ç–∞–∫–∏–º–∏ –∂–µ –∫–∞–∫ –≤ –ø—Ä–µ–¥—ã–¥—É—â–µ–º –ø—Ä–∏–º–µ—Ä–µ */
    :root {
      --primary: #FF5722;
      --secondary: #607D8B;
      --accent: #FFC107;
      --dark: #263238;
      --light: #ECEFF1;
    }
    body {
      font-family: 'Rubik', sans-serif;
      background-color: var(--dark);
      color: var(--light);
      margin: 0;
      padding: 20px;
    }
    .container {
      max-width: 800px;
      margin: 0 auto;
    }
    /* ... –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ ... */
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>–û–∂–∏–¥–∞–Ω–∏–µ –∏–≥—Ä–æ–∫–æ–≤</h1>
      <div class="lobby-id" id="lobby-id">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
    </div>
    
    <div class="players-list" id="players-list">
      <p>–ó–∞–≥—Ä—É–∑–∫–∞ –∏–≥—Ä–æ–∫–æ–≤...</p>
    </div>
    
    <button class="start-btn" id="start-game" style="display:none;">–ù–ê–ß–ê–¢–¨ –ò–ì–†–£</button>
    
    <div class="chat-container">
      <h2>–ß–∞—Ç –ª–æ–±–±–∏</h2>
      <div class="chat-messages" id="chat-messages">
        <p>–ß–∞—Ç –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è...</p>
      </div>
      <div class="chat-input-container">
        <input type="text" id="chat-input" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." disabled>
        <button id="send-message" disabled>–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
      </div>
    </div>
  </div>

  <!-- –¢–æ–ª—å–∫–æ –æ–¥–Ω–∞ –≤–µ—Ä—Å–∏—è Firebase! -->
  <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
  
  <script>
    // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Firebase (–ó–ê–ú–ï–ù–ò–¢–ï –ù–ê –°–í–û–Æ!)
    const firebaseConfig = {
      apiKey: "AIzaSyABC123...",
      authDomain: "–≤–∞—à-–ø—Ä–æ–µ–∫—Ç.firebaseapp.com",
      databaseURL: "https://–≤–∞—à-–ø—Ä–æ–µ–∫—Ç-default-rtdb.firebaseio.com",
      projectId: "–≤–∞—à-–ø—Ä–æ–µ–∫—Ç",
      storageBucket: "",
      messagingSenderId: "123456789",
      appId: "1:123456789:web:abc123def456"
    };

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase
    const app = firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const auth = firebase.auth();

    // –ü–æ–ª—É—á–∞–µ–º ID –ª–æ–±–±–∏ –∏–∑ URL
    const urlParams = new URLSearchParams(window.location.search);
    const lobbyId = urlParams.get('id');
    
    if (!lobbyId) {
      alert("–û—à–∏–±–∫–∞: –Ω–µ —É–∫–∞–∑–∞–Ω ID –ª–æ–±–±–∏!");
      window.location.href = 'index.html';
    }

    // –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
    async function initLobby() {
      try {
        // 1. –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è
        const user = await auth.signInAnonymously();
        
        // 2. –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ª–æ–±–±–∏
        const lobbyRef = db.ref(`lobbies/${lobbyId}`);
        lobbyRef.on('value', (snapshot) => {
          const lobby = snapshot.val();
          
          if (!lobby) {
            alert("–õ–æ–±–±–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ!");
            window.location.href = 'index.html';
            return;
          }
          
          updateLobbyUI(lobby);
        });
        
        // 3. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —á–∞—Ç–∞
        setupChat();
        
        // 4. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–Ω–æ–ø–∫–∏ "–ù–∞—á–∞—Ç—å –∏–≥—Ä—É"
        document.getElementById('start-game').addEventListener('click', startGame);
        
        // 5. –£–¥–∞–ª–µ–Ω–∏–µ –∏–≥—Ä–æ–∫–∞ –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ
        db.ref(`lobbies/${lobbyId}/players/${user.uid}`).onDisconnect().remove();
        
      } catch (error) {
        console.error("–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:", error);
        alert("–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞: " + error.message);
      }
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ –ª–æ–±–±–∏
    function updateLobbyUI(lobby) {
      // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫
      document.getElementById('lobby-id').textContent = `–õ–æ–±–±–∏ #${lobbyId}`;
      
      // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –∏–≥—Ä–æ–∫–æ–≤
      const playersContainer = document.getElementById('players-list');
      playersContainer.innerHTML = '';
      
      if (!lobby.players) {
        playersContainer.innerHTML = '<p>–ù–µ—Ç –∏–≥—Ä–æ–∫–æ–≤ –≤ –ª–æ–±–±–∏</p>';
        return;
      }
      
      Object.entries(lobby.players).forEach(([id, player]) => {
        const playerCard = document.createElement('div');
        playerCard.className = `player-card ${player.isHost ? 'host' : ''}`;
        playerCard.innerHTML = `
          <h3>${player.name || '–ë–µ–∑ –∏–º–µ–Ω–∏'}</h3>
          <p>$${player.money?.toLocaleString() || '0'}</p>
          ${player.isHost ? '<p>üëë –í–µ–¥—É—â–∏–π</p>' : ''}
        `;
        playersContainer.appendChild(playerCard);
      });
      
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É "–ù–∞—á–∞—Ç—å –∏–≥—Ä—É" —Ç–æ–ª—å–∫–æ –¥–ª—è –≤–µ–¥—É—â–µ–≥–æ
      document.getElementById('start-game').style.display = 
        lobby.host === auth.currentUser?.uid ? 'block' : 'none';
    }

    // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —á–∞—Ç–∞
    function setupChat() {
      const chatRef = db.ref(`chats/${lobbyId}`);
      const chatInput = document.getElementById('chat-input');
      const sendButton = document.getElementById('send-message');
      const chatMessages = document.getElementById('chat-messages');
      
      // –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞
      chatInput.disabled = false;
      sendButton.disabled = false;
      chatMessages.innerHTML = '';
      
      // –°–ª—É—à–∞–µ–º –Ω–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
      chatRef.limitToLast(50).on('child_added', (snapshot) => {
        const message = snapshot.val();
        displayMessage(message);
      });
      
      // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
      sendButton.addEventListener('click', sendMessage);
      chatInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') sendMessage();
      });
      
      function sendMessage() {
        const text = chatInput.value.trim();
        if (!text) return;
        
        const user = auth.currentUser;
        if (!user) return;
        
        // –ü–æ–ª—É—á–∞–µ–º –∏–º—è –∏–≥—Ä–æ–∫–∞
        db.ref(`lobbies/${lobbyId}/players/${user.uid}/name`).once('value')
          .then((snapshot) => {
            const userName = snapshot.val() || '–ê–Ω–æ–Ω–∏–º';
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
            chatRef.push({
              sender: userName,
              text: text,
              timestamp: firebase.database.ServerValue.TIMESTAMP
            });
            
            chatInput.value = '';
          });
      }
      
      function displayMessage(message) {
        const messageElement = document.createElement('div');
        messageElement.className = 'message';
        
        const time = new Date(message.timestamp).toLocaleTimeString([], {
          hour: '2-digit',
          minute: '2-digit'
        });
        
        messageElement.innerHTML = `
          <span class="message-sender">${message.sender}:</span>
          <span>${message.text}</span>
          <span class="message-time">${time}</span>
        `;
        
        chatMessages.appendChild(messageElement);
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }
    }

    // –ù–∞—á–∞–ª–æ –∏–≥—Ä—ã
    async function startGame() {
      try {
        await db.ref(`lobbies/${lobbyId}`).update({
          status: "starting",
          startTime: firebase.database.ServerValue.TIMESTAMP
        });
        
        window.location.href = `game.html?id=${lobbyId}`;
      } catch (error) {
        alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –∏–≥—Ä—ã: " + error.message);
      }
    }

    // –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
    document.addEventListener('DOMContentLoaded', initLobby);
  </script>
</body>
</html>
